<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Intent Recognition - Client Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/dashboard" class="text-xl font-bold text-gray-800">API Intent Recognition</a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/dashboard" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/clients" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Client Management</a>
                        <a href="/settings" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Settings</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Client Management</h2>
                    <button id="addClientBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Add New Client
                    </button>
                </div>

                <!-- Client List -->
                <div class="space-y-6" id="clientList">
                    <!-- Clients will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Client Modal -->
    <div id="clientModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modalTitle">Add New Client</h3>
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="clientName">
                            Client Name
                        </label>
                        <input type="text" id="clientName" name="name" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4" id="statusContainer" style="display: none;">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Status
                        </label>
                        <select id="clientStatus" name="status"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancelClientBtn"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">
                            Cancel
                        </button>
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div id="editApiModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="editApiModalTitle">Edit API Configuration</h3>
                <form id="editApiForm">
                    <input type="hidden" id="editApiConfigId">
                    <input type="hidden" id="editApiClientId">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiName">
                            API Name
                        </label>
                        <input type="text" id="editApiName" name="api_name" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="e.g., employee, client, project">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiBaseUrl">
                            Base URL
                        </label>
                        <input type="url" id="editApiBaseUrl" name="api_base_url" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="https://api.example.com">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiToken">
                            API Token
                        </label>
                        <input type="text" id="editApiToken" name="api_token" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="your-api-token-here">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiVersion">
                                Version
                            </label>
                            <input type="text" id="editApiVersion" name="api_version" 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                placeholder="v1">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiTimeout">
                                Timeout (seconds)
                            </label>
                            <input type="number" id="editApiTimeout" name="timeout_seconds" min="1" max="300"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                placeholder="30">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editApiDescription">
                            Description
                        </label>
                        <textarea id="editApiDescription" name="description" rows="3"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Description of this API integration"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Status
                        </label>
                        <select id="editApiActive" name="active"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" id="cancelEditApiBtn"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">
                            Cancel
                        </button>
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal (Main List) -->
    <div id="apiConfigModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-40">
        <div class="relative top-10 mx-auto p-5 border w-5/6 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900" id="apiModalTitle">API Configurations</h3>
                    <button id="addNewApiBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Add New API
                    </button>
                </div>
                <div id="apiConfigContent">
                    <!-- API configurations will be loaded here -->
                </div>
                <div class="flex justify-end mt-4">
                    <button id="closeApiConfigBtn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Templates Modal -->
    <div id="parameterTemplatesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-45">
        <div class="relative top-10 mx-auto p-5 border w-5/6 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900" id="parameterTemplatesTitle">Parameter Templates</h3>
                    <div class="flex space-x-2">
                        <button id="addNewParameterTemplateBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Add Parameter Template
                        </button>
                        <button id="closeParameterTemplatesBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                            Close
                        </button>
                    </div>
                </div>
                <div id="parameterTemplatesContent">
                    <!-- Parameter templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Parameter Template Modal -->
    <div id="editParameterTemplateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-55">
        <div class="relative top-10 mx-auto p-5 border w-4/5 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="editParameterTemplateTitle">Add Parameter Template</h3>
                <form id="editParameterTemplateForm">
                    <input type="hidden" id="editParameterTemplateId">
                    <input type="hidden" id="editParameterTemplateApiConfigId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="editParameterTemplateName">
                                Template Name
                            </label>
                            <input type="text" id="editParameterTemplateName" name="template_name" required
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                placeholder="e.g., salary_lookup">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="editParameterTemplateMethod">
                                HTTP Method
                            </label>
                            <select id="editParameterTemplateMethod" name="http_method"
                                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editParameterTemplateEndpoint">
                            Endpoint Path
                        </label>
                        <input type="text" id="editParameterTemplateEndpoint" name="endpoint_path" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="e.g., /payroll, /employees/{emp_id}">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="editParameterTemplateDescription">
                            Description
                        </label>
                        <textarea id="editParameterTemplateDescription" name="description" rows="2"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Description of this parameter template"></textarea>
                    </div>
                    
                    <!-- Query Parameters Section -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">Query Parameters</label>
                            <button type="button" id="addQueryParamBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                Add Parameter
                            </button>
                        </div>
                        <div id="queryParametersContainer" class="space-y-2">
                            <!-- Query parameters will be added here -->
                        </div>
                    </div>
                    
                    <!-- Response Mapping Section -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">Response Mapping</label>
                            <button type="button" id="addResponseMappingBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                Add Mapping
                            </button>
                        </div>
                        <div id="responseMappingContainer" class="space-y-2">
                            <!-- Response mappings will be added here -->
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" id="cancelParameterTemplateBtn"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">
                            Cancel
                        </button>
                        <button type="submit"
                            class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                            Save Template
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Check if user is authenticated
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login';
        });

        // Parameter Template Management Variables
        let currentApiConfigId = null;
        let currentApiConfigName = null;

        // Parameter Template Modal Elements
        const parameterTemplatesModal = document.getElementById('parameterTemplatesModal');
        const parameterTemplatesTitle = document.getElementById('parameterTemplatesTitle');
        const parameterTemplatesContent = document.getElementById('parameterTemplatesContent');
        const closeParameterTemplatesBtn = document.getElementById('closeParameterTemplatesBtn');
        const addNewParameterTemplateBtn = document.getElementById('addNewParameterTemplateBtn');

        // Edit Parameter Template Modal Elements
        const editParameterTemplateModal = document.getElementById('editParameterTemplateModal');
        const editParameterTemplateForm = document.getElementById('editParameterTemplateForm');
        const editParameterTemplateTitle = document.getElementById('editParameterTemplateTitle');
        const cancelParameterTemplateBtn = document.getElementById('cancelParameterTemplateBtn');

        // Form Elements
        const editParameterTemplateId = document.getElementById('editParameterTemplateId');
        const editParameterTemplateApiConfigId = document.getElementById('editParameterTemplateApiConfigId');
        const editParameterTemplateName = document.getElementById('editParameterTemplateName');
        const editParameterTemplateMethod = document.getElementById('editParameterTemplateMethod');
        const editParameterTemplateEndpoint = document.getElementById('editParameterTemplateEndpoint');
        const editParameterTemplateDescription = document.getElementById('editParameterTemplateDescription');

        // Dynamic form containers
        const queryParametersContainer = document.getElementById('queryParametersContainer');
        const responseMappingContainer = document.getElementById('responseMappingContainer');
        const addQueryParamBtn = document.getElementById('addQueryParamBtn');
        const addResponseMappingBtn = document.getElementById('addResponseMappingBtn');

        // Event Listeners
        closeParameterTemplatesBtn.addEventListener('click', () => {
            parameterTemplatesModal.classList.add('hidden');
        });

        addNewParameterTemplateBtn.addEventListener('click', () => {
            openParameterTemplateForm();
        });

        cancelParameterTemplateBtn.addEventListener('click', () => {
            editParameterTemplateModal.classList.add('hidden');
        });

        addQueryParamBtn.addEventListener('click', () => {
            addQueryParameterField();
        });

        addResponseMappingBtn.addEventListener('click', () => {
            addResponseMappingField();
        });


        // Client management variables
        // Variables for API config management
        let currentClientId = null;
        let currentClientName = null;

        // Enhanced API Config Modal elements
        const addNewApiBtn = document.getElementById('addNewApiBtn');
        const editApiModal = document.getElementById('editApiModal');
        const editApiForm = document.getElementById('editApiForm');
        const cancelEditApiBtn = document.getElementById('cancelEditApiBtn');
        const editApiModalTitle = document.getElementById('editApiModalTitle');

        // Form fields
        const editApiConfigId = document.getElementById('editApiConfigId');
        const editApiClientId = document.getElementById('editApiClientId');
        const editApiName = document.getElementById('editApiName');
        const editApiBaseUrl = document.getElementById('editApiBaseUrl');
        const editApiToken = document.getElementById('editApiToken');
        const editApiVersion = document.getElementById('editApiVersion');
        const editApiTimeout = document.getElementById('editApiTimeout');
        const editApiDescription = document.getElementById('editApiDescription');
        const editApiActive = document.getElementById('editApiActive');

        // Modal elements
        const clientModal = document.getElementById('clientModal');
        const clientForm = document.getElementById('clientForm');
        const addClientBtn = document.getElementById('addClientBtn');
        const cancelClientBtn = document.getElementById('cancelClientBtn');
        const modalTitle = document.getElementById('modalTitle');
        const clientId = document.getElementById('clientId');
        const clientName = document.getElementById('clientName');
        const clientStatus = document.getElementById('clientStatus');
        const statusContainer = document.getElementById('statusContainer');

        // API Config Modal elements
        const apiConfigModal = document.getElementById('apiConfigModal');
        const closeApiConfigBtn = document.getElementById('closeApiConfigBtn');
        const apiModalTitle = document.getElementById('apiModalTitle');
        const apiConfigContent = document.getElementById('apiConfigContent');

        // Load clients on page load
        loadClients();


        addNewApiBtn.addEventListener('click', () => {
            editApiModalTitle.textContent = 'Add New API Configuration';
            editApiForm.reset();
            editApiConfigId.value = '';
            editApiClientId.value = currentClientId;
            editApiVersion.value = 'v1';
            editApiTimeout.value = '30';
            editApiActive.value = '1';
            editApiModal.classList.remove('hidden');
        });

        // Cancel edit API button
        cancelEditApiBtn.addEventListener('click', () => {
            editApiModal.classList.add('hidden');
        });

        // Edit API form submit
        editApiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const isEdit = editApiConfigId.value !== '';
            const formData = {
                api_name: editApiName.value,
                api_base_url: editApiBaseUrl.value,
                api_token: editApiToken.value,
                api_version: editApiVersion.value || 'v1',
                timeout_seconds: parseInt(editApiTimeout.value) || 30,
                description: editApiDescription.value,
                active: parseInt(editApiActive.value)
            };

            if (!isEdit) {
                formData.client_id = editApiClientId.value;
            }

            try {
                const url = isEdit ? 
                    `/api/client-api-configs/${editApiConfigId.value}` : 
                    `/api/clients/${editApiClientId.value}/api-configs`;
                
                const response = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    editApiModal.classList.add('hidden');
                    // Refresh the API configurations
                    viewApiConfigs(currentClientId, currentClientName);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'An error occurred');
                }
            } catch (error) {
                alert('An error occurred while saving the API configuration');
            }
        });

        // Add client button click
        addClientBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Client';
            clientForm.reset();
            clientId.value = '';
            statusContainer.style.display = 'none';
            clientModal.classList.remove('hidden');
        });

        // Cancel button click
        cancelClientBtn.addEventListener('click', () => {
            clientModal.classList.add('hidden');
        });

        // Close API config modal
        closeApiConfigBtn.addEventListener('click', () => {
            apiConfigModal.classList.add('hidden');
        });

        // Form submit
        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                name: clientName.value,
                ...(clientId.value && { active: parseInt(clientStatus.value) })
            };

            try {
                const url = clientId.value ? 
                    `/api/clients/${clientId.value}` : 
                    '/api/clients';
                
                const response = await fetch(url, {
                    method: clientId.value ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    clientModal.classList.add('hidden');
                    loadClients();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'An error occurred');
                }
            } catch (error) {
                alert('An error occurred');
            }
        });

        // Load clients
        async function loadClients() {
            try {
                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const clients = await response.json();
                    displayClients(clients);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'An error occurred');
                }
            } catch (error) {
                alert('An error occurred');
            }
        }

        // Display clients with enhanced UI
        function displayClients(clients) {
            const clientList = document.getElementById('clientList');
            
            if (clients.length === 0) {
                clientList.innerHTML = '<p class="text-gray-500 text-center py-8">No clients found</p>';
                return;
            }
            
            clientList.innerHTML = clients.map(client => `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${client.name}</h3>
                            <p class="text-sm text-gray-500 mt-1">Created: ${new Date(client.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${client.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${client.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">API Key</label>
                            <div class="mt-1 flex items-center">
                                <code class="text-sm bg-gray-100 px-2 py-1 rounded flex-1 truncate">${client.api_key}</code>
                                <button onclick="copyToClipboard('${client.api_key}')" class="ml-2 text-blue-600 hover:text-blue-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <p class="mt-1 text-sm text-gray-900">${client.description || 'No description'}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button onclick="viewApiConfigs('${client.id}', '${client.name}')" 
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            API Configs
                        </button>
                        <div class="space-x-2">
                            <button onclick="editClient('${client.id}', '${client.name}', ${client.active})"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Edit
                            </button>
                            <button onclick="deleteClient('${client.id}')"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show a brief notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                notification.textContent = 'API key copied to clipboard!';
                document.body.appendChild(notification);
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // View API configurations
        async function viewApiConfigs(clientId, clientName) {
            currentClientId = clientId;
            currentClientName = clientName;
            
            apiModalTitle.textContent = `API Configurations - ${clientName}`;
            
            try {
                const response = await fetch(`/api/clients/${clientId}/api-configs`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const configs = await response.json();
                    displayApiConfigs(configs);
                    apiConfigModal.classList.remove('hidden');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to load API configurations');
                }
            } catch (error) {
                alert('An error occurred while loading API configurations');
            }
        }

        // Display API configurations
        function displayApiConfigs(configs) {
            if (configs.length === 0) {
                apiConfigContent.innerHTML = '<p class="text-gray-500 text-center py-8">No API configurations found. Click "Add New API" to get started.</p>';
                return;
            }

            apiConfigContent.innerHTML = `
                <div class="grid grid-cols-1 gap-4">
                    ${configs.map(config => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="text-lg font-semibold text-gray-900 capitalize">${config.api_name} API</h4>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${config.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${config.active ? 'Active' : 'Inactive'}
                                    </span>
                                    <button onclick="viewParameterTemplates('${config.id}', '${config.api_name}')" 
                                        class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                        Parameters
                                    </button>
                                    <button onclick="editApiConfig('${config.id}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        Edit
                                    </button>
                                    <button onclick="deleteApiConfig('${config.id}')" 
                                        class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <label class="block font-medium text-gray-700">Base URL</label>
                                    <code class="text-blue-600 bg-blue-50 px-2 py-1 rounded block mt-1 truncate">${config.api_base_url}</code>
                                </div>
                                <div>
                                    <label class="block font-medium text-gray-700">Token</label>
                                    <code class="text-gray-600 bg-gray-100 px-2 py-1 rounded block mt-1 truncate">${config.api_token}</code>
                                </div>
                                <div>
                                    <label class="block font-medium text-gray-700">Version</label>
                                    <span class="text-gray-900 mt-1 block">${config.api_version}</span>
                                </div>
                                <div>
                                    <label class="block font-medium text-gray-700">Timeout</label>
                                    <span class="text-gray-900 mt-1 block">${config.timeout_seconds}s</span>
                                </div>
                            </div>
                            ${config.description ? `
                                <div class="mt-3">
                                    <label class="block font-medium text-gray-700">Description</label>
                                    <p class="text-gray-600 mt-1">${config.description}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // View Parameter Templates Function
        async function viewParameterTemplates(apiConfigId, apiName) {
            currentApiConfigId = apiConfigId;
            currentApiConfigName = apiName;
            
            parameterTemplatesTitle.textContent = `Parameter Templates - ${apiName.toUpperCase()} API`;
            
            try {
                const response = await fetch(`/api/clients/${currentClientId}/api-configs/${apiConfigId}/parameter-templates`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const templates = await response.json();
                    displayParameterTemplates(templates);
                    parameterTemplatesModal.classList.remove('hidden');
                } else {
                    // For now, show a placeholder since we haven't implemented the backend endpoint yet
                    displayParameterTemplates([]);
                    parameterTemplatesModal.classList.remove('hidden');
                }
            } catch (error) {
                console.log('Parameter templates endpoint not implemented yet, showing placeholder');
                displayParameterTemplates([]);
                parameterTemplatesModal.classList.remove('hidden');
            }
        }

        // Display Parameter Templates
        function displayParameterTemplates(templates) {
            if (templates.length === 0) {
                parameterTemplatesContent.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">No parameter templates found for this API.</p>
                        <p class="text-sm text-gray-400">Parameter templates help define how to call this API with different parameters.</p>
                    </div>
                `;
                return;
            }

            parameterTemplatesContent.innerHTML = `
                <div class="grid grid-cols-1 gap-4">
                    ${templates.map(template => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h5 class="text-md font-semibold text-gray-900">${template.template_name}</h5>
                                    <p class="text-sm text-gray-600">${template.description || 'No description'}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                        ${template.http_method}
                                    </span>
                                    <button onclick="editParameterTemplate('${template.id}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        Edit
                                    </button>
                                    <button onclick="deleteParameterTemplate('${template.id}')" 
                                        class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm">
                                <p><strong>Endpoint:</strong> <code class="bg-gray-100 px-1 rounded">${template.endpoint_path}</code></p>
                                <p class="mt-1"><strong>Parameters:</strong> ${Object.keys(template.parameter_template?.query_params || {}).join(', ') || 'None'}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Open Parameter Template Form
        function openParameterTemplateForm(templateData = null) {
            const isEdit = templateData !== null;
            
            editParameterTemplateTitle.textContent = isEdit ? 'Edit Parameter Template' : 'Add Parameter Template';
            editParameterTemplateForm.reset();
            
            if (isEdit) {
                editParameterTemplateId.value = templateData.id;
                editParameterTemplateName.value = templateData.template_name;
                editParameterTemplateMethod.value = templateData.http_method;
                editParameterTemplateEndpoint.value = templateData.endpoint_path;
                editParameterTemplateDescription.value = templateData.description || '';
            } else {
                editParameterTemplateId.value = '';
                editParameterTemplateMethod.value = 'GET';
            }
            
            editParameterTemplateApiConfigId.value = currentApiConfigId;
            
            // Clear dynamic fields
            queryParametersContainer.innerHTML = '';
            responseMappingContainer.innerHTML = '';
            
            // Add default fields
            addQueryParameterField();
            addResponseMappingField();
            
            editParameterTemplateModal.classList.remove('hidden');
        }

        // Add Query Parameter Field
        function addQueryParameterField(paramData = null) {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded';
            div.innerHTML = `
                <input type="text" placeholder="Parameter name" value="${paramData?.name || ''}" 
                    class="col-span-3 px-2 py-1 border rounded text-sm" name="param_name">
                <select class="col-span-2 px-2 py-1 border rounded text-sm" name="param_type">
                    <option value="string" ${paramData?.type === 'string' ? 'selected' : ''}>String</option>
                    <option value="number" ${paramData?.type === 'number' ? 'selected' : ''}>Number</option>
                    <option value="boolean" ${paramData?.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                    <option value="array" ${paramData?.type === 'array' ? 'selected' : ''}>Array</option>
                </select>
                <input type="text" placeholder="Default value" value="${paramData?.default || ''}"
                    class="col-span-2 px-2 py-1 border rounded text-sm" name="param_default">
                <input type="text" placeholder="Source field" value="${paramData?.source || ''}"
                    class="col-span-2 px-2 py-1 border rounded text-sm" name="param_source">
                <label class="col-span-1 flex items-center text-sm">
                    <input type="checkbox" ${paramData?.required ? 'checked' : ''} name="param_required"> Required
                </label>
                <input type="text" placeholder="Description" value="${paramData?.description || ''}"
                    class="col-span-1 px-2 py-1 border rounded text-sm" name="param_description">
                <button type="button" onclick="this.parentElement.remove()" 
                    class="col-span-1 text-red-600 hover:text-red-800 text-sm">Remove</button>
            `;
            queryParametersContainer.appendChild(div);
        }

        // Add Response Mapping Field
        function addResponseMappingField(mappingData = null) {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-3 gap-2 items-center bg-gray-50 p-2 rounded';
            div.innerHTML = `
                <input type="text" placeholder="Field name (e.g., salary)" value="${mappingData?.field || ''}"
                    class="px-2 py-1 border rounded text-sm" name="mapping_field">
                <input type="text" placeholder="JSON path (e.g., $.data.salary)" value="${mappingData?.path || ''}"
                    class="px-2 py-1 border rounded text-sm" name="mapping_path">
                <button type="button" onclick="this.parentElement.remove()" 
                    class="text-red-600 hover:text-red-800 text-sm">Remove</button>
            `;
            responseMappingContainer.appendChild(div);
        }

        // Placeholder functions for now
        function editParameterTemplate(templateId) {
            alert('Edit parameter template functionality will be implemented when we add the backend endpoints');
        }

        function deleteParameterTemplate(templateId) {
            if (confirm('Are you sure you want to delete this parameter template?')) {
                alert('Delete parameter template functionality will be implemented when we add the backend endpoints');
            }
        }

        // Edit API configuration
        async function editApiConfig(configId) {
            try {
                // First, get the current API configurations to find the one we want to edit
                const response = await fetch(`/api/clients/${currentClientId}/api-configs`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const configs = await response.json();
                    const config = configs.find(c => c.id === configId);
                    
                    if (config) {
                        editApiModalTitle.textContent = `Edit ${config.api_name.toUpperCase()} API Configuration`;
                        editApiConfigId.value = config.id;
                        editApiClientId.value = config.client_id;
                        editApiName.value = config.api_name;
                        editApiBaseUrl.value = config.api_base_url;
                        editApiToken.value = config.api_token;
                        editApiVersion.value = config.api_version;
                        editApiTimeout.value = config.timeout_seconds;
                        editApiDescription.value = config.description || '';
                        editApiActive.value = config.active;
                        
                        editApiModal.classList.remove('hidden');
                    } else {
                        alert('API configuration not found');
                    }
                } else {
                    alert('Failed to load API configuration');
                }
            } catch (error) {
                alert('An error occurred while loading the API configuration');
            }
        }

        // Delete API configuration
        async function deleteApiConfig(configId) {
            if (confirm('Are you sure you want to delete this API configuration?')) {
                try {
                    const response = await fetch(`/api/client-api-configs/${configId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        // Refresh the API configurations
                        viewApiConfigs(currentClientId, currentClientName);
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Failed to delete API configuration');
                    }
                } catch (error) {
                    alert('An error occurred while deleting the API configuration');
                }
            }
        }

        // Edit client
        function editClient(id, name, status) {
            modalTitle.textContent = 'Edit Client';
            clientId.value = id;
            clientName.value = name;
            clientStatus.value = status;
            statusContainer.style.display = 'block';
            clientModal.classList.remove('hidden');
        }

        // Delete client
        async function deleteClient(id) {
            if (confirm('Are you sure you want to delete this client? This will also delete all their API configurations.')) {
                try {
                    const response = await fetch(`/api/clients/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        loadClients();
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'An error occurred');
                    }
                } catch (error) {
                    alert('An error occurred');
                }
            }
        }
    </script>
</body>
</html>
